# Runs checks on every pull request
name: Integration

on:
  pull_request:
    branches:
      - main
  workflow_call:

jobs:
  checks:
    name: Checks
    runs-on: ubuntu-latest
    if: github.head_ref != 'changeset-release/main' # Skips the entire job for changeset PRs
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup CI Environment
        uses: ./.github/actions/setup-ci

      - name: Restore Caches
        uses: actions/cache@v4
        with:
          path: |
            .cache/.eslintcache
            .cache/.prettier-cache
          key: ${{ runner.os }}-checks-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Run Linting and Type Checks
        env:
          NODE_OPTIONS: '--max-old-space-size=4096'
        run: |
          pnpm svelte-kit sync
          pnpm prettier --check --cache --cache-location=.cache/.prettier-cache --cache-strategy content .
          pnpm eslint --cache --cache-location=.cache/.eslintcache --cache-strategy content .
          pnpm svelte-check --tsconfig ./tsconfig.json

  tests:
    # test
    name: Run Tests
    runs-on: ubuntu-latest
    if: github.head_ref != 'changeset-release/main'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup CI Environment
        uses: ./.github/actions/setup-ci

      - name: Restore Vitest Cache
        uses: actions/cache@v4
        with:
          path: .cache/.vite
          key: ${{ runner.os }}-vitest-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-vitest-

      - name: Run Unit Tests
        run: |
          pnpm svelte-kit sync
          pnpm test

  check-changeset:
    name: Check for Changeset
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.head_ref != 'changeset-release/main'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup CI Environment
        uses: ./.github/actions/setup-ci

      - name: Verify Changeset File
        run: 'pnpm changeset status --since origin/main'
